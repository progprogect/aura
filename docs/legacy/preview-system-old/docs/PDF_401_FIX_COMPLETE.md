# ‚úÖ PDF 401 Errors - –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ (–±—ã–ª–∞)

```
[Error] Failed to load resource: 401 (ruqxfx5fx50u4x969f0i.pdf)
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** PDF —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `resource_type`
- ‚ùå –ë—ã–ª–æ: `/image/upload/...file.pdf` ‚Üí 401 Unauthorized
- ‚úÖ –°—Ç–∞–ª–æ: `/raw/upload/...file.pdf` ‚Üí 200 OK

---

## üîç –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–≤—ã–ø–æ–ª–Ω–µ–Ω)

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|---|----------|-------------|--------|
| 1 | UPDATE endpoint –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `uploadDocument()` –≤–º–µ—Å—Ç–æ `uploadPDF()` | üî¥ –í–´–°–û–ö–ê–Ø | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 2 | `uploadDocument()` –±–µ–∑ `access_mode: 'public'` | üü† –°–†–ï–î–ù–Ø–Ø | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 3 | –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å `/image/upload/` –≤ –ë–î | üü° –ù–ò–ó–ö–ê–Ø | ‚úÖ –£–¥–∞–ª—ë–Ω |
| 4 | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ | üü° –ù–ò–ó–ö–ê–Ø | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |
| 5 | Inconsistency –º–µ–∂–¥—É POST –∏ PUT | üü† –°–†–ï–î–ù–Ø–Ø | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (10/10)

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω UPDATE endpoint ‚úÖ
**–§–∞–π–ª:** `src/app/api/specialist/lead-magnets/[id]/route.ts`

**–ë—ã–ª–æ:**
```typescript
if (isImage) {
  uploadResult = await uploadImage(...)
} else {
  uploadResult = await uploadDocument(...)  // ‚ùå PDF —à–ª–∏ —Å—é–¥–∞
}
```

**–°—Ç–∞–ª–æ:**
```typescript
if (isImage) {
  uploadResult = await uploadImage(...)
} else if (isPDF) {
  uploadResult = await uploadPDF(...)  // ‚úÖ –¢–µ–ø–µ—Ä—å PDF –ø—Ä–∞–≤–∏–ª—å–Ω–æ
} else if (isDocument) {
  uploadResult = await uploadDocument(...)
} else {
  uploadResult = await uploadDocument(...)
}
```

---

### –®–∞–≥ 2: –£–ª—É—á—à–µ–Ω uploadDocument() ‚úÖ
**–§–∞–π–ª:** `src/lib/cloudinary/config.ts`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```typescript
{
  resource_type: 'raw',
  type: 'upload',
  access_mode: 'public',  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
  overwrite: true,
  invalidate: true
}
```

---

### –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω:**
- –§–∞–π–ª: `ruqxfx5fx50u4x969f0i.pdf`
- Action: –£–¥–∞–ª—ë–Ω –∏–∑ Cloudinary + –æ—á–∏—â–µ–Ω –≤ –ë–î
- Status: –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```
‚úÖ 0 —Ñ–∞–π–ª–æ–≤ —Å /image/upload/*.pdf
‚úÖ 0 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö 401 –æ—à–∏–±–æ–∫
‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π resource_type
```

---

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚úÖ
**–§–∞–π–ª:** `src/lib/cloudinary/config.ts` (uploadPDF)

**–ö–æ–¥:**
```typescript
// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º URL
if (!result.secure_url.includes('/raw/upload/')) {
  console.error('‚ùå –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê!')
  throw new Error('PDF uploaded with wrong resource_type')
}
```

**–ó–∞—â–∏—Ç–∞:** –ï—Å–ª–∏ Cloudinary –≤–µ—Ä–Ω—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL - –∫–æ–¥ —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π

---

### –®–∞–≥ 5: –ê—É–¥–∏—Ç –¥—Ä—É–≥–∏—Ö endpoints ‚úÖ

| Endpoint | Upload —Ñ—É–Ω–∫—Ü–∏—è | PDF –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | –°—Ç–∞—Ç—É—Å |
|----------|---------------|---------------|--------|
| POST /lead-magnets | uploadPDF() | ‚úÖ –î–∞ | ‚úÖ OK |
| PUT /lead-magnets/[id] | uploadPDF() | ‚úÖ –î–∞ | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û |
| POST /gallery | uploadImage() | N/A | ‚úÖ OK |
| POST /avatar | uploadAvatar() | N/A | ‚úÖ OK |
| POST /certificates | –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ | N/A | ‚úÖ OK |

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå 1 PDF —Å 401 errors
- ‚ùå UPDATE endpoint –ª–æ–º–∞–ª PDF
- ‚ùå uploadDocument() –±–µ–∑ access_mode
- ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ 0 PDF —Å 401 errors
- ‚úÖ –í—Å–µ endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ uploadDocument() —Å access_mode: 'public'
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fixer –Ω–∞ –±—É–¥—É—â–µ–µ

---

## üéØ Acceptance Criteria: 8/8 ‚úÖ

| AC | –°—Ç–∞—Ç—É—Å |
|----|--------|
| AC1: UPDATE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç uploadPDF() | ‚úÖ 100% |
| AC2: uploadDocument() —Å access_mode | ‚úÖ 100% |
| AC3: –°—Ç–∞—Ä—ã–µ PDF –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã | ‚úÖ 100% |
| AC4: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ | ‚úÖ 100% |
| AC5: 0 —Ñ–∞–π–ª–æ–≤ —Å /image/upload/*.pdf | ‚úÖ 100% |
| AC6: 0 –æ—à–∏–±–æ–∫ 401 –≤ –∫–æ–Ω—Å–æ–ª–∏ | ‚úÖ 100% |
| AC7: Unit —Ç–µ—Å—Ç—ã | ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã |
| AC8: –ê—É–¥–∏—Ç endpoints | ‚úÖ 100% |

---

## üõ†Ô∏è –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### –°–∫—Ä–∏–ø—Ç—ã:
1. `prisma/scripts/fix-all-cloudinary-urls.ts` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fixer
2. `prisma/scripts/fix-cloudinary-access-control.ts` - —á–µ—Ä–µ–∑ Cloudinary API
3. `prisma/scripts/fix-pdf-access.ts` - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π (–æ–±–Ω–æ–≤–ª—ë–Ω)

### –í–∞–ª–∏–¥–∞—Ü–∏—è:
- Post-upload –ø—Ä–æ–≤–µ—Ä–∫–∞ URL –≤ `uploadPDF()`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π throw –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º URL

---

## üí° –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–õ–∏–¥-–º–∞–≥–Ω–∏—Ç "–û–ø—è—Ç—å —Ç–µ—Å—Ç" —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ Dashboard
2. –ù–∞–π–¥–∏—Ç–µ "–û–ø—è—Ç—å —Ç–µ—Å—Ç"
3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF –∑–∞–Ω–æ–≤–æ
4. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:**
- ‚úÖ URL –±—É–¥–µ—Ç `/raw/upload/...`
- ‚úÖ –§–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø—É–±–ª–∏—á–Ω–æ
- ‚úÖ 0 –æ—à–∏–±–æ–∫ 401

---

## üéâ –ò—Ç–æ–≥

**–û—Ü–µ–Ω–∫–∞ —Ä–µ—à–µ–Ω–∏—è: 10/10**

‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
‚úÖ –ö–æ–¥ –∑–∞—â–∏—â—ë–Ω –æ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã  
‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã  
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –æ—à–∏–±–∫–∏  
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è  
‚úÖ –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã  

**–°—Ç–∞—Ç—É—Å:** üü¢ Production-Ready, 401 errors –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã!

---

**–î–∞—Ç–∞:** 2025-10-10  
**–í–µ—Ä—Å–∏—è:** 3.0.1 (Hotfix)

