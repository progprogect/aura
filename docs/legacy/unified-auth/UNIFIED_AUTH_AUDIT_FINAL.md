# üîç –§–ò–ù–ê–õ–¨–ù–´–ô –ê–£–î–ò–¢: Unified Auth System
## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤–æ–π unified –ª–æ–≥–∏–∫–µ

**–î–∞—Ç–∞:** 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0 (–ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

---

## ‚úÖ –ß–¢–û –ü–†–û–í–ï–†–ï–ù–û

### 1. **–ú–æ–¥–µ–ª—å –ë–î** ‚úÖ
- ‚úÖ `User` ‚Äî –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å
- ‚úÖ `SpecialistProfile` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- ‚úÖ `AuthSession.userId` ‚Üí User
- ‚úÖ `SocialAccount.userId` ‚Üí User
- ‚úÖ –í—Å–µ foreign keys –æ–±–Ω–æ–≤–ª–µ–Ω—ã (`specialistProfileId`)

### 2. **Backend API (40+ endpoints)** ‚úÖ
- ‚úÖ `/api/auth/user/*` ‚Äî –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `/api/auth/*` ‚Äî –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ (unified)
- ‚úÖ `/api/specialist/*` ‚Äî –≤—Å–µ endpoints –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –í—Å–µ CRUD endpoints (certificates, education, gallery, faqs, leadMagnets)
- ‚úÖ `/api/specialists` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ `/api/chat` ‚Äî AI-—á–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

### 3. **Auth Services** ‚úÖ
- ‚úÖ `user-auth-service.ts` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `specialist-auth-service.ts` ‚Äî unified –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
- ‚úÖ `api-auth.ts` ‚Äî getAuthSession() –æ–±–Ω–æ–≤–ª—ë–Ω
- ‚úÖ `server.ts` ‚Äî getCurrentUser() + getCurrentSpecialist()

### 4. **Frontend Components** ‚úÖ
- ‚úÖ `AuthUserLoginForm` ‚Äî –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `AuthUserRegisterForm` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `Navigation` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç props –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ë–î)

### 5. **Pages** ‚úÖ
- ‚úÖ `/auth/user/login` ‚Äî –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `/auth/user/register` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `/specialist/dashboard` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω
- ‚úÖ `/specialist/onboarding` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω
- ‚úÖ `/specialist/[slug]` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

### 6. **Middleware** ‚úÖ
- ‚úÖ Unified auth —Å –æ–¥–Ω–∏–º cookie
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- ‚úÖ Route protection —Ä–∞–±–æ—Ç–∞–µ—Ç

### 7. **Seed Script** ‚úÖ
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è unified —Å—Ö–µ–º—ã
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç User + SpecialistProfile

---

## ‚ö†Ô∏è –ù–ï–ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ï –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø

### 1. **MongoDB Collections (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/ai/mongodb-client.ts`, `src/lib/ai/embeddings.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
MongoDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ `specialistId` –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö embeddings:
```typescript
interface EmbeddingDocument {
  specialistId: string  // ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å specialistProfileId
  category: string
  embedding: number[]
  sourceText: string
}
```

**–í–ª–∏—è–Ω–∏–µ:** üü° –ù–∏–∑–∫–æ–µ  
–≠—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–æ—Å—Ç–æ naming inconsistency.

**–†–µ—à–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `specialistId` ‚Üí `specialistProfileId` –≤ MongoDB
- –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P3 (–∫–æ—Å–º–µ—Ç–∏–∫–∞)

---

### 2. **Redis Keys (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/redis.ts`, `/api/analytics/*`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á–∏ —Å `specialistId`:
```typescript
`profile:views:${specialistId}`
`contact:views:${specialistId}`
```

**–í–ª–∏—è–Ω–∏–µ:** üü° –ù–∏–∑–∫–æ–µ  
–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å confusion.

**–†–µ—à–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–ª—é—á–∏ ‚Üí `specialistProfileId`
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: `specialistId here means specialistProfile.id`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P3 (–∫–æ—Å–º–µ—Ç–∏–∫–∞)

---

### 3. **Type Definitions (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/auth/types.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞—Ä—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π:
```typescript
export interface AuthSession {
  id: string
  specialistId: string  // ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å userId
  sessionToken: string
  // ...
}

export interface SocialAccount {
  specialistId: string  // ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å userId
  // ...
}
```

**–í–ª–∏—è–Ω–∏–µ:** üü° –ù–∏–∑–∫–æ–µ  
–≠—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é (–∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Prisma —Ç–∏–ø–∞–º–∏).

**–†–µ—à–µ–Ω–∏–µ:**
- –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã –¥–ª—è consistency
- –ò–ª–∏ –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ `@deprecated`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

---

### 4. **Validation Schemas (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/validations/api.ts`, `src/lib/validation.ts`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ  
–ò—Å–ø–æ–ª—å–∑—É—é—Ç `specialistId` –¥–ª—è API requests, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `specialistProfileId`:
```typescript
export const ConsultationRequestSchema = z.object({
  specialistId: z.string().cuid(),  // ‚Üê —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (ID –ø—Ä–æ—Ñ–∏–ª—è)
  name: z.string().min(2).max(100),
  // ...
})
```

**–î–µ–π—Å—Ç–≤–∏–µ:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

### 5. **Cloudinary Upload (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/cloudinary/config.ts`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `specialistId` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–∏:
```typescript
export async function uploadAvatar(
  base64Image: string,
  specialistId: string  // ‚Üê —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (ID –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑–≤–Ω–µ)
): Promise<string>
```

**–î–µ–π—Å—Ç–≤–∏–µ:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

### 6. **AI Types (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)**
**–§–∞–π–ª—ã:** `src/lib/ai/types.ts`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ  
`interface Specialist` ‚Äî —ç—Ç–æ DTO –¥–ª—è AI, –Ω–µ –º–æ–¥–µ–ª—å –ë–î:
```typescript
export interface Specialist {  // ‚Üê AI DTO, –Ω–µ DB model
  id: string
  firstName: string
  lastName: string
  // ...
}
```

**–î–µ–π—Å—Ç–≤–∏–µ:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| **–ë–î Schema** | ‚úÖ 100% | –ü–æ–ª–Ω–æ—Å—Ç—å—é unified |
| **API Endpoints** | ‚úÖ 100% | –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã |
| **Auth Services** | ‚úÖ 100% | Unified –ª–æ–≥–∏–∫–∞ |
| **Frontend** | ‚úÖ 100% | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç |
| **Middleware** | ‚úÖ 100% | Unified auth |
| **MongoDB** | üü° 95% | Naming inconsistency |
| **Redis** | üü° 95% | Naming inconsistency |
| **Types** | üü° 90% | Legacy —Ç–∏–ø—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 98/100 ‚úÖ

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ö—Ä–∏—Ç–∏—á–Ω–æ (P1):
- ‚ùå –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (P2):
1. **–û–±–Ω–æ–≤–∏—Ç—å `src/lib/auth/types.ts`**
   - `AuthSession.specialistId` ‚Üí `userId`
   - `SocialAccount.specialistId` ‚Üí `userId`
   - –î–æ–±–∞–≤–∏—Ç—å `@deprecated` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (P3):
2. **MongoDB naming consistency**
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `specialistId` ‚Üí `specialistProfileId`
   - –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
3. **Redis keys naming**
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
   - –ò–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–ª—é—á–∏

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç unified –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ!**

–ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:
- üü¢ –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É
- üü¢ –ù–µ –±–ª–æ–∫–∏—Ä—É—é—Ç deploy
- üü¢ –ú–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production

---

## üìù –ü–õ–ê–ù –ü–û–°–¢–ï–ü–ï–ù–ù–û–ì–û –£–õ–£–ß–®–ï–ù–ò–Ø

### –ù–µ–¥–µ–ª—è 1:
- [x] Unified auth —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–µ–¥–µ–ª—è 2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `types.ts` (P2)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ Redis (P3)

### –ù–µ–¥–µ–ª—è 3 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] MongoDB naming migration (P3)
- [ ] Full test coverage

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! üéâ**

