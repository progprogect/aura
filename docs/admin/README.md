# Админ-панель Эволюция 360

## Описание

Админ-панель для управления платформой Эволюция 360. Позволяет верифицировать специалистов, блокировать пользователей и специалистов, добавлять баллы, просматривать статистику.

## Доступ

- URL: `/admin/login`
- Доступ только по прямой ссылке (нет навигации из основной части системы)
- Защищено middleware и требует авторизации

## Функциональность

### 1. Статистика (`/admin/dashboard`)
- Общее количество пользователей и специалистов
- Статистика заказов и конверсий
- Баллы в системе
- Активность (просмотры, заявки, отзывы)
- Графики регистраций и заказов по дням
- Распределение специалистов по категориям

### 2. Управление специалистами (`/admin/specialists`)
- Просмотр списка специалистов с фильтрами
- Поиск по имени, slug, телефону
- Фильтры: верификация, блокировка, категория
- Детальный просмотр специалиста:
  - Верификация/снятие верификации
  - Блокировка/разблокировка профиля специалиста
  - Блокировка/разблокировка пользователя
  - Начисление бонусных баллов
  - Просмотр статистики, заказов, отзывов, транзакций

### 3. Управление пользователями (`/admin/users`)
- Просмотр списка пользователей
- Поиск по имени, телефону, email
- Фильтры: блокировка, наличие профиля специалиста
- Блокировка/разблокировка пользователей

## Создание администратора

### На сервере

```bash
DATABASE_URL="postgresql://..." npm run admin:create
```

Или установите переменную окружения `DATABASE_URL` или `DATABASE_PUBLIC_URL` и запустите:

```bash
npm run admin:create
```

### Локально

```bash
# Установите DATABASE_URL в .env или передайте как переменную окружения
DATABASE_URL="postgresql://..." npm run admin:create
```

## Безопасность

- Пароли хранятся в зашифрованном виде (bcrypt)
- Сессии админов отделены от пользовательских сессий
- Защита админ-роутов через middleware
- Блокировка в robots.txt (`/admin` disallowed)
- Сессии с TTL 24 часа

## API Endpoints

### Аутентификация
- `POST /api/admin/auth/login` - Вход
- `POST /api/admin/auth/logout` - Выход
- `GET /api/admin/auth/me` - Текущий админ

### Статистика
- `GET /api/admin/stats?period=day|week|month|all` - Общая статистика

### Специалисты
- `GET /api/admin/specialists` - Список специалистов
- `GET /api/admin/specialists/[id]` - Детали специалиста
- `PATCH /api/admin/specialists/[id]/verify` - Верификация
- `PATCH /api/admin/specialists/[id]/block` - Блокировка профиля
- `POST /api/admin/specialists/[id]/points` - Начисление баллов

### Пользователи
- `GET /api/admin/users` - Список пользователей
- `PATCH /api/admin/users/[id]/block` - Блокировка пользователя

## Миграции

### Применение миграций на сервере

```bash
DATABASE_URL="postgresql://..." npx prisma migrate deploy
```

### Создание новой миграции

```bash
DATABASE_URL="postgresql://..." npx prisma migrate dev --name migration_name
```

## Структура базы данных

### Модель Admin
- `id` - ID администратора
- `username` - Логин (уникальный)
- `passwordHash` - Хеш пароля
- `sessions` - Сессии админа

### Модель AdminSession
- `id` - ID сессии
- `adminId` - ID администратора
- `sessionToken` - Токен сессии (уникальный)
- `userAgent` - User Agent браузера
- `ipAddress` - IP адрес
- `isActive` - Активна ли сессия
- `expiresAt` - Время истечения
- `lastUsedAt` - Время последнего использования

### Поля блокировки в User
- `blocked` - Заблокирован ли пользователь
- `blockedAt` - Время блокировки
- `blockedReason` - Причина блокировки

### Поля блокировки в SpecialistProfile
- `blocked` - Заблокирован ли профиль специалиста
- `blockedAt` - Время блокировки
- `blockedReason` - Причина блокировки

## Разработка

### Локальная разработка

1. Установите переменные окружения:
   ```bash
   DATABASE_URL="postgresql://..."
   ```

2. Примените миграции:
   ```bash
   npx prisma migrate dev
   ```

3. Создайте администратора:
   ```bash
   npm run admin:create
   ```

4. Запустите dev сервер:
   ```bash
   npm run dev
   ```

5. Откройте админ-панель:
   ```
   http://localhost:3000/admin/login
   ```

### Деплой на сервер

1. Примените миграции:
   ```bash
   DATABASE_URL="postgresql://..." npx prisma migrate deploy
   ```

2. Создайте администратора:
   ```bash
   DATABASE_URL="postgresql://..." npm run admin:create
   ```

3. Установите переменные окружения на сервере:
   - `DATABASE_URL` или `DATABASE_PUBLIC_URL`

4. Перезапустите приложение

## Заметки

- Админ-панель доступна только по прямой ссылке
- Нет навигации из основной части системы
- Все действия логируются через транзакции
- Блокировка пользователя блокирует и его профиль специалиста (если есть)
- Блокировка профиля специалиста не блокирует пользователя
- Баллы начисляются как бонусные (`bonus_reward`) с сроком действия 7 дней

