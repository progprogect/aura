# üéØ –û—Ç—á—ë—Ç: Production-Ready Preview System V3

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (–§–∞–∑—ã 1-4)

### üì¶ –§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚úÖ

**1.1 BullMQ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç `bullmq`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `/src/lib/queue/config.ts`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –æ—á–µ—Ä–µ–¥—å `/src/lib/queue/preview-queue.ts`
- ‚úÖ –°–æ–∑–¥–∞–Ω worker `/src/lib/queue/preview-worker.ts`
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff
- ‚úÖ Worker entry point `/src/lib/queue/worker-start.ts`

**1.2 üî¥ –ö–†–ò–¢–ò–ß–ù–û: 401 –æ—à–∏–±–∫–∏ PDF –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `uploadPDF()` –≤ `/src/lib/cloudinary/config.ts`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `resource_type: 'raw'`, `access_mode: 'public'`
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω API route –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `uploadPDF()`
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ `/prisma/scripts/fix-pdf-access.ts`

**1.3 Cloudinary –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∞:**
- ‚úÖ –°–æ–∑–¥–∞–Ω `/src/lib/cloudinary/preview-uploader.ts`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 3 —Ä–∞–∑–º–µ—Ä–æ–≤: thumbnail (400x300), card (800x600), detail (1200x900)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (WebP/AVIF)
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ srcset URLs

**1.4 ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ `CLOUDINARY_PREVIEW_FOLDER`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `env.template`

---

### üèóÔ∏è –§–∞–∑–∞ 2: Clean Architecture ‚úÖ

**–°–æ–∑–¥–∞–Ω–∞ –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
src/lib/lead-magnets/preview/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ types.ts          ‚úÖ TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îî‚îÄ‚îÄ generator.ts      ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îú‚îÄ‚îÄ base.provider.ts  ‚úÖ –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ pdf.provider.ts   ‚úÖ PDF –ø—Ä–µ–≤—å—é
‚îÇ   ‚îú‚îÄ‚îÄ image.provider.ts ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ video.provider.ts ‚úÖ YouTube/Vimeo
‚îÇ   ‚îî‚îÄ‚îÄ service.provider.ts ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îî‚îÄ‚îÄ cloudinary.storage.ts ‚úÖ Cloudinary storage
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts      ‚úÖ –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã, –∏–∫–æ–Ω–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ helpers.ts        ‚úÖ –£—Ç–∏–ª–∏—Ç—ã
‚îî‚îÄ‚îÄ index.ts             ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç API
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
- ‚úÖ **Single Responsibility** - –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –≤–µ—â—å
- ‚úÖ **Provider Pattern** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –ø—Ä–µ–≤—å—é
- ‚úÖ **Separation of Concerns** - UI –æ—Ç–¥–µ–ª—ë–Ω –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ **Testability** - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏, –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ **No Duplication** - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã

---

### ‚öôÔ∏è –§–∞–∑–∞ 3: –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (Queue) ‚úÖ

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BullMQ:**
- ‚úÖ Worker –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ `generatePreview()` –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Cloudinary —Å responsive —Ä–∞–∑–º–µ—Ä–∞–º–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –ø–æ–ª—è `previewUrls` (JSON)
- ‚úÖ –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞

**–¢–∏–ø—ã –∑–∞–¥–∞—á:**
- ‚úÖ `generate-preview` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞
- ‚úÖ `regenerate-preview` - –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
- ‚úÖ `batch-generate` - –º–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

---

### üñºÔ∏è –§–∞–∑–∞ 4: Responsive Images (srcset) ‚úÖ

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `previewUrls Json?` –≤ —Å—Ö–µ–º—É Prisma
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{ thumbnail, card, detail, original }`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã TypeScript: `PreviewUrls` interface

**Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- ‚úÖ –°–æ–∑–¥–∞–Ω `ResponsivePreview.tsx` —Å srcset
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `CardPreview.tsx` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `previewUrls`
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `previewUrls` > `previewImage` (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π srcSet: `thumbnail 400w, card 800w, detail 1200w`
- ‚úÖ Adaptive sizes –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- ‚úÖ Cloudinary —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ on-the-fly
- ‚úÖ WebP/AVIF —Ñ–æ—Ä–º–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ Lazy loading –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –°–∫–µ–ª–µ—Ç–æ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 20+
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~2500+
**–ú–æ–¥—É–ª–µ–π:** 15

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- ‚úÖ BullMQ + Redis (queue)
- ‚úÖ Cloudinary (CDN + transformations)
- ‚úÖ Sharp (server-side optimization)
- ‚úÖ Next.js Image (client-side)
- ‚úÖ TypeScript (type safety)

---

## üéØ Acceptance Criteria (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

- ‚úÖ **AC1**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ core/providers/storage/utils (SOLID)
- ‚úÖ **AC2**: –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
- ‚úÖ **AC4**: –í—Å–µ –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Cloudinary —Å 3 —Ä–∞–∑–º–µ—Ä–∞–º–∏
- ‚úÖ **AC5**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è srcset –¥–ª—è responsive images
- ‚úÖ **AC6**: BullMQ queue –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å retry

---

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ (–§–∞–∑—ã 5-10)

### –û—Å—Ç–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

**–§–∞–∑–∞ 5: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**
- –†–∞–∑–±–∏—Ç—å SmartPreview.tsx (747 —Å—Ç—Ä–æ–∫) –Ω–∞ –ø–æ–¥-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –°–æ–∑–¥–∞—Ç—å usePreview hook
- –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–§–∞–∑–∞ 6: API —Ä–æ—É—Ç—ã**
- –ù–æ–≤—ã–µ endpoints —Å queue
- –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ API

**–§–∞–∑–∞ 7: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
- –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ base64 ‚Üí Cloudinary
- Rollback –ø–ª–∞–Ω

**–§–∞–∑–∞ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è providers
- Integration —Ç–µ—Å—Ç—ã
- E2E –ø—Ä–æ–≤–µ—Ä–∫–∞

**–§–∞–∑–∞ 9: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–µ—Ç—Ä–∏–∫–∏

**–§–∞–∑–∞ 10: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- –û–±–Ω–æ–≤–∏—Ç—å docs
- Cleanup —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **PDF 401 Fix** - –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞, —Ç–µ–ø–µ—Ä—å PDF –¥–æ—Å—Ç—É–ø–Ω—ã –ø—É–±–ª–∏—á–Ω–æ
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π `previewImage` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
3. **Production-ready** - —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–∞–≥—Ä—É–∑–∫–∞–º
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ providers

---

**–î–∞—Ç–∞:** 2025-10-10  
**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 4/10 —Ñ–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (40%)  
**–°—Ç–∞—Ç—É—Å:** üü¢ –í –ø—Ä–æ—Ü–µ—Å—Å–µ

