# Система комиссий и кешбэка

## Описание

Система автоматически взимает комиссию платформы (5%) с каждой покупки лид-магнитов и услуг, и возвращает половину комиссии (2.5%) пользователю в качестве кешбэка.

## Архитектура

### Модель данных

- **PlatformRevenue** - отдельная модель для хранения всех комиссий и кешбэков
- **Order.commissionProcessed**, **cashbackProcessed** - флаги для предотвращения двойной обработки
- **LeadMagnetPurchase.commissionProcessed**, **cashbackProcessed** - аналогично

### Логика транзакций

#### Покупка лид-магнита (100 баллов):
1. Списание у клиента: -100 баллов
2. Начисление специалисту: +95 баллов (95%)
3. Начисление платформе: +5 баллов (5% комиссия)
4. Кешбэк клиенту: +2.5 баллов (бонусные, сгорают через 7 дней)
5. Списание кешбэка с платформы: -2.5 баллов

**Итоговый баланс:**
- Клиент: -100 + 2.5 = -97.5
- Специалист: +95
- Платформа: +5 - 2.5 = +2.5
- **Итого: 0** ✅

#### Покупка услуги (100 баллов):

**При покупке:**
1. Списание у клиента: -100 баллов
2. Кешбэк клиенту: +2.5 баллов (бонусные)

**При подтверждении заказа:**
3. Начисление специалисту: +95 баллов (95%)
4. Начисление платформе: +5 баллов (5% комиссия)
5. Списание кешбэка с платформы: -2.5 баллов

**Итоговый баланс:**
- Клиент: -100 + 2.5 = -97.5
- Специалист: +95
- Платформа: +5 - 2.5 = +2.5
- **Итого: 0** ✅

## Компоненты

### CommissionService

Основной сервис для обработки комиссий:
- `calculate(amount)` - расчет комиссий
- `processLeadMagnetPurchase(...)` - обработка покупки лид-магнита
- `addCashbackForService(...)` - начисление кешбэка при покупке услуги
- `processServiceCompletion(...)` - обработка завершения услуги

### BalanceValidator

Валидатор для проверки баланса:
- `validateBalance(...)` - проверка баланса после операции
- `auditPeriod(...)` - аудит всех транзакций за период
- `validatePlatformBalance()` - проверка общего баланса платформы

## API Endpoints

### Покупки
- `POST /api/lead-magnets/[id]/purchase` - покупка лид-магнита с комиссией
- `POST /api/orders/create-with-points` - создание заказа с кешбэком
- `PATCH /api/orders/[id]/confirm` - подтверждение заказа (клиент или специалист)
- `PATCH /api/orders/[id]/self-confirm` - подтверждение заказа специалистом
- `PATCH /api/proposals/[id]/accept` - принятие отклика с кешбэком

### Админ-панель
- `GET /api/admin/revenue/overview` - общая статистика комиссий
- `GET /api/admin/revenue/transactions` - история транзакций
- `GET /api/admin/revenue/user/[userId]` - комиссии по пользователю
- `GET /api/admin/revenue/specialist/[specialistId]` - комиссии по специалисту

## UI

- `/admin/revenue` - страница комиссий в админ-панели
- `PurchaseConfirmModal` - показывает кешбэк при покупке

## Системный пользователь

Для работы системы необходимо создать системного пользователя платформы:

```bash
DATABASE_URL="..." tsx prisma/scripts/create-platform-user.ts
```

ID пользователя: `platform-system-user`

## Гарантии баланса

- Все операции выполняются в одной Prisma транзакции (ACID)
- Валидация баланса после каждой операции
- Защита от двойной обработки через флаги `commissionProcessed`, `cashbackProcessed`
- Использование Decimal для точных расчетов

## Тестирование

Unit тесты: `src/lib/commission/__tests__/commission-service.test.ts`

