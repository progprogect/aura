# üí∞ –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤ ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –ß—Ç–æ —ç—Ç–æ?

**–°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤ (Points System)** ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≠–≤–æ–ª—é—Ü–∏—è 360 –¥–ª—è –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ —É—Å–ª—É–≥ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
DATABASE_PUBLIC_URL="postgresql://..." npm run migrate:points

# 2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è —Å–≥–æ—Ä–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤
# –°–º. CRON_SETUP.md

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
npm run dev
```

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** ‚Üí –ü–æ–ª—É—á–∏—Ç–µ 50 –±–æ–Ω—É—Å–Ω—ã—Ö –±–∞–ª–ª–æ–≤
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ** –±–∞–ª–ª—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π
3. **–ü–æ–ø–æ–ª–Ω—è–π—Ç–µ** –±–∞–ª–∞–Ω—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —É—Å–ª—É–≥ (Phase 2)

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### –¢–∏–ø—ã –±–∞–ª–ª–æ–≤

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –°–≥–æ—Ä–∞—é—Ç? | –ú–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å? |
|-----|----------|----------|-----------------|
| **–û–±—ã—á–Ω—ã–µ** | –ü–æ–∫—É–ø–∞—é—Ç—Å—è –∑–∞ –¥–µ–Ω—å–≥–∏ | –ù–µ—Ç | –î–∞ (Phase 2) |
| **–ë–æ–Ω—É—Å–Ω—ã–µ** | –ó–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ | –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π | –ù–µ—Ç |

### –õ–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è

–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Å–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–±–æ–Ω—É—Å–Ω—ã–µ**, –∑–∞—Ç–µ–º **–æ–±—ã—á–Ω—ã–µ** –±–∞–ª–ª—ã.

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

| –î–æ–∫—É–º–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã, —Ç–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| [API.md](./API.md) | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API endpoints |
| [ROADMAP.md](./ROADMAP.md) | –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è Phase 2 |
| [CRON_SETUP.md](./CRON_SETUP.md) | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≥–æ—Ä–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ |

### –î–ª—è –∫–æ–≥–æ

- **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏:** ARCHITECTURE.md, API.md
- **–ü—Ä–æ–¥—É–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä—ã:** ROADMAP.md
- **DevOps:** CRON_SETUP.md

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Backend

```
src/lib/points/
‚îú‚îÄ‚îÄ points-service.ts   # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–∞–ª–ª–æ–≤
‚îú‚îÄ‚îÄ format.ts           # –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ types.ts            # TypeScript —Ç–∏–ø—ã

src/app/api/
‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îú‚îÄ‚îÄ balance/        # GET –±–∞–ª–∞–Ω—Å
‚îÇ   ‚îî‚îÄ‚îÄ transactions/   # GET –∏—Å—Ç–æ—Ä–∏—è
‚îî‚îÄ‚îÄ cron/
    ‚îî‚îÄ‚îÄ expire-bonuses/ # –°–≥–æ—Ä–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
```

### Frontend

```
src/components/points/
‚îú‚îÄ‚îÄ BalanceChip.tsx               # –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å (—Ö–µ–¥–µ—Ä)
‚îú‚îÄ‚îÄ BalanceWidget.tsx             # –î–µ—Ç–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–õ–ö)
‚îú‚îÄ‚îÄ BalanceWidgetWrapper.tsx      # Wrapper —Å –º–æ–¥–∞–ª–∫–æ–π
‚îî‚îÄ‚îÄ TransactionHistoryModal.tsx   # –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

### Database

```prisma
User {
  balance        Decimal   // –û–±—ã—á–Ω—ã–µ –±–∞–ª–ª—ã
  bonusBalance   Decimal   // –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã
  bonusExpiresAt DateTime? // –ö–æ–≥–¥–∞ —Å–≥–æ—Ä—è—Ç
}

Transaction {
  type        String   // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
  amount      Decimal  // –°—É–º–º–∞
  balanceType String   // balance | bonusBalance
}

Currency {
  code         String  // BYN, RUB, USD
  rateToPoints Decimal // –ö—É—Ä—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
}
```

---

## API Endpoints

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ

```
GET  /api/user/balance        # –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
GET  /api/user/transactions   # –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

### Cron (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)

```
GET  /api/cron/expire-bonuses # –°–≥–æ—Ä–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
```

---

## Phase 1 vs Phase 2

### ‚úÖ Phase 1 (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

- [x] –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [x] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [x] –°–≥–æ—Ä–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ (cron)
- [x] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI
- [x] –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### üîú Phase 2 (–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

- [ ] –ü–æ–∫—É–ø–∫–∞ –∑–∞ –±–∞–ª–ª—ã (–ª–∏–¥-–º–∞–≥–Ω–∏—Ç—ã, –ø—Ä–æ–¥—É–∫—Ç—ã)
- [ ] –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (Stripe, –ï–†–ò–ü)
- [ ] –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏
- [ ] –ë–æ–Ω—É—Å—ã –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

---

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞)

### Backend: –ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å—ã

```typescript
import { PointsService } from '@/lib/points/points-service';
import { Decimal } from '@prisma/client/runtime/library';

// –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
await PointsService.grantRegistrationBonus(userId);

// –ó–∞ –¥–µ–π—Å—Ç–≤–∏–µ (Phase 2)
await PointsService.addPoints(
  userId,
  new Decimal(20),
  'bonus_reward',
  'bonusBalance',
  '–ë–æ–Ω—É—Å –∑–∞ –ø–µ—Ä–≤—ã–π –æ—Ç–∑—ã–≤'
);
```

### Backend: –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã

```typescript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
const hasEnough = await PointsService.hasEnoughPoints(
  userId,
  new Decimal(50)
);

if (!hasEnough) {
  return { error: 'Insufficient balance' };
}

// –°–ø–∏—Å–∞—Ç—å
const transactions = await PointsService.deductPoints(
  userId,
  new Decimal(50),
  'purchase',
  '–ü–æ–∫—É–ø–∫–∞ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞ "–ì–∞–π–¥ –ø–æ –ø–∏—Ç–∞–Ω–∏—é"',
  { leadMagnetId: 'xxx' }
);
```

### Frontend: –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å

```tsx
import { BalanceChip } from '@/components/points/BalanceChip';
import { BalanceWidget } from '@/components/points/BalanceWidget';

// –í —Ö–µ–¥–µ—Ä–µ
<BalanceChip />

// –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
<BalanceWidget onOpenHistory={() => setIsOpen(true)} />
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ACID-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Prisma `$transaction` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏.

### Audit Log

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `Transaction` —Å:
- –ë–∞–ª–∞–Ω—Å–æ–º –¥–æ/–ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –¢–∏–ø–æ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

### –ó–∞—â–∏—Ç–∞ Cron

Endpoint `/api/cron/expire-bonuses` —Ç—Ä–µ–±—É–µ—Ç:
```
Authorization: Bearer <CRON_SECRET>
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏

- –û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤/–¥–µ–Ω—å
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π/–¥–µ–Ω—å

### –õ–æ–≥–∏

```bash
railway logs --filter="[CRON]"
railway logs --filter="[PointsService]"
```

---

## FAQ

### –ü–æ—á–µ–º—É –±–∞–ª–ª—ã, –∞ –Ω–µ —Ä—É–±–ª–∏/–¥–æ–ª–ª–∞—Ä—ã?

- **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫—É—Ä—Å—ã –±–µ–∑ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –±–∞–∑—ã
- **–ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:** –û–¥–Ω–∏ –±–∞–ª–ª—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω
- **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ó–≤—É—á–∏—Ç –º–µ–Ω–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

### –ü–æ—á–µ–º—É –±–æ–Ω—É—Å—ã —Å–≥–æ—Ä–∞—é—Ç?

- **Urgency:** –°—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- **–ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞—Ç—Ä–∞—Ç:** –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- **Fairness:** –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –±–æ–ª—å—à–µ

### –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è?

–î–∞, –≤ `PointsService.BONUS_EXPIRY_DAYS` (—Å–µ–π—á–∞—Å 7 –¥–Ω–µ–π).

### –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ?

```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
npm run test:auth

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
curl http://localhost:3000/api/user/balance \
  -H "Cookie: session_token=xxx"

# 3. –í—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å cron
curl http://localhost:3000/api/cron/expire-bonuses \
  -H "Authorization: Bearer test_secret"
```

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–í–æ–ø—Ä–æ—Å—ã?** –û—Ç–∫—Ä–æ–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π:
- Telegram: @aura_support
- Email: support@aura.app

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–ß–∞—Å—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç ¬© 2025 –≠–≤–æ–ª—é—Ü–∏—è 360 Platform

